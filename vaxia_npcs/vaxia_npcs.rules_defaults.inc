<?php
/**
 * @file
 * vaxia_npcs.rules_defaults.inc
 */

/**
 * Implements hook_default_rules_configuration().
 */
function vaxia_npcs_default_rules_configuration() {
  $items = array();
  $items['rules_notify_char_eval_re_oversight_npc'] = entity_import('rules_config', '{ "rules_notify_char_eval_re_oversight_npc" : {
      "LABEL" : "Notify char eval re: OVERSIGHT NPC",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Vaxia" ],
      "REQUIRES" : [ "rules", "workflow_rules", "php" ],
      "ON" : { "workflow_state_changed" : [] },
      "IF" : [
        { "node_is_of_type" : {
            "node" : [ "node" ],
            "type" : { "value" : { "character_sheet" : "character_sheet" } }
          }
        },
        { "workflow_check_transition" : {
            "node" : [ "node" ],
            "old_state" : { "value" : { "ANY" : "ANY" } },
            "new_state" : { "value" : { "3" : "3" } }
          }
        },
        { "php_eval" : { "code" : "$limit = 70;\\r\\n$return_value = FALSE;\\r\\n$fields = array(\\u0027life\\u0027, \\u0027health\\u0027, \\u0027endurance\\u0027, \\u0027constitution\\u0027, \\u0027strength\\u0027, \\u0027agility\\u0027, \\u0027dexterity\\u0027,\\r\\n\\u0027reflexes\\u0027, \\u0027intelligence\\u0027, \\u0027awareness\\u0027, \\u0027spirituality\\u0027, \\u0027presence\\u0027, \\u0027charisma\\u0027, \\u0027appearance\\u0027,\\r\\n);\\r\\n$lang = $node-\\u003Elanguage;\\r\\nforeach ($fields as $field_name) {\\r\\n  $field_name = \\u0027field_\\u0027 . $field_name;\\r\\n  $stat = isset($node-\\u003E{$field_name}[$lang][0][\\u0027value\\u0027]) ?\\r\\n    $node-\\u003E{$field_name}[$lang][0][\\u0027value\\u0027] : 0;\\r\\n  if ($stat \\u003E= $limit) {\\r\\n    $return_value = TRUE;\\r\\n  }\\r\\n  foreach ($node-\\u003Efield_skill[$lang] as $delta =\\u003E $skill) {\\r\\n    $this_skill = field_collection_item_load($skill[\\u0027value\\u0027]);\\r\\n    $skill_lang = isset($skill-\\u003Elanguage) ? $skill-\\u003Elanguage : $lang;\\r\\n    $stat = isset($this_skill-\\u003Efield_skill_value[$skill_lang][0][\\u0027value\\u0027]) ?\\r\\n      $this_skill-\\u003Efield_skill_value[$skill_lang][0][\\u0027value\\u0027] : 0;\\r\\n    if ($stat \\u003E= $limit) {\\r\\n      $return_value = TRUE;\\r\\n    }\\r\\n  }\\r\\n}\\r\\nreturn $return_value;" } },
        { "OR" : [
            { "data_is" : { "data" : [ "node:field-is-npc" ], "value" : 1 } },
            { "data_is" : { "data" : [ "node:field-is-open-npc" ], "value" : 1 } }
          ]
        }
      ],
      "DO" : [
        { "drupal_message" : {
            "message" : "This character falls under OVERSIGHT as it has a stat or skill over 70 points. Please consider if this character is absolutely necessary to have available for play on the site and be ready to validate the need and use of the character.",
            "type" : "warning",
            "repeat" : 0
          }
        },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "9" : "9", "4" : "4", "3" : "3" } },
            "subject" : "[Vaxia] A NPC has been submitted that needs OVERSIGHT",
            "message" : "An NPC has been submitted that requires oversight.\\r\\n\\r\\nOne (or more) of its stats or skills exceeds 70 points, so NPC requires additional oversight. This character CANNOT be approved without review by an SH (not [node:author]) with notes marked in the workflow regarding intention and use of the NPC in play. NPCs that fall under oversight must be relevant to current play and intended for use in a session within the next 3 months.  \\r\\n\\r\\nYou are receiving this email because you are one of the people available to evaluate characters. Please do so before \\u003C?php print date(\\u0027m\\/d\\/Y\\u0027, strtotime(\\u0027+1 week\\u0027)); ?\\u003E. If this character does not meet the requirements to be approved, please revert it to \\u0022draft\\u0022 status and send a Private Message to the player with the details on how to bring it up to an approvable quality. Copy the same notes into the Workflow Comments when you make the change so that we have a record of it with the character itself.\\r\\n\\r\\nIf you are not comfortable with approving characters at all, please speak to any of the current heads to update your access privileges.\\r\\n\\r\\nCharacter: [node:title]\\r\\nPlayer: [node:author]\\r\\nLink: [node:url]\\r\\n\\r\\nAdditional characters or items that need oversight may be found at: http:\\/\\/vaxia.org\\/oversight\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will\\r\\nnot be received by a human.\\r\\n~~~~~~"
          }
        }
      ]
    }
  }');
  $items['rules_request_npc'] = entity_import('rules_config', '{ "rules_request_npc" : {
      "LABEL" : "Request NPC",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Vaxia NPCs" ],
      "REQUIRES" : [ "rules", "vaxia_npcs" ],
      "ON" : { "vaxia_npcs_request" : [] },
      "DO" : [
        { "mail" : {
            "to" : "[node:author:mail], [user:mail]",
            "subject" : "[Vaxia] NPC [node:title] requested for use by [user:name]",
            "message" : "Another SH is requesting to the NPC [node:title] for sessions.\\r\\n\\r\\nYou are receiving this email because you are the current owner of this NPC. [user:name] would like to use this NPC for sessions. Since the NPC is currently listed as inactive it should be available for use, but we encourage coordination between our SHs. Please get back to [user:name] as promptly as you can regarding the use of this character and any on-going plots or special considerations that need to be taken into account when playing with this NPC.\\r\\n\\r\\nCharacter: [node:title]\\r\\nLink: [node:url]\\r\\n\\r\\nRequesting SH: [user:name], [user:mail] \\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~",
            "from" : "[user:mail]",
            "language" : [ "" ]
          }
        }
      ]
    }
  }');
  $items['vaxia_notify_char_eval_re_oversight_npc_pass_npc'] = entity_import('rules_config', '{ "vaxia_notify_char_eval_re_oversight_npc_pass_npc" : {
      "LABEL" : "Notify char eval re: OVERSIGHT NPC - pass_npc",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Vaxia" ],
      "REQUIRES" : [ "rules", "workflow_rules", "php" ],
      "ON" : { "workflow_state_changed" : [] },
      "IF" : [
        { "node_is_of_type" : {
            "node" : [ "node" ],
            "type" : { "value" : { "character_sheet" : "character_sheet" } }
          }
        },
        { "workflow_check_transition" : {
            "node" : [ "node" ],
            "old_state" : { "value" : { "ANY" : "ANY" } },
            "new_state" : { "value" : { "3" : "3" } }
          }
        },
        { "NOT php_eval" : { "code" : "$limit = 70;\\r\\n$return_value = FALSE;\\r\\n$fields = array(\\u0027life\\u0027, \\u0027health\\u0027, \\u0027endurance\\u0027, \\u0027constitution\\u0027, \\u0027strength\\u0027, \\u0027agility\\u0027, \\u0027dexterity\\u0027,\\r\\n\\u0027reflexes\\u0027, \\u0027intelligence\\u0027, \\u0027awareness\\u0027, \\u0027spirituality\\u0027, \\u0027presence\\u0027, \\u0027charisma\\u0027, \\u0027appearance\\u0027,\\r\\n);\\r\\n$lang = $node-\\u003Elanguage;\\r\\nforeach ($fields as $field_name) {\\r\\n  $field_name = \\u0027field_\\u0027 . $field_name;\\r\\n  $stat = isset($node-\\u003E{$field_name}[$lang][0][\\u0027value\\u0027]) ?\\r\\n    $node-\\u003E{$field_name}[$lang][0][\\u0027value\\u0027] : 0;\\r\\n  if ($stat \\u003E= $limit) {\\r\\n    $return_value = TRUE;\\r\\n  }\\r\\n  foreach ($node-\\u003Efield_skill[$lang] as $delta =\\u003E $skill) {\\r\\n    $this_skill = field_collection_item_load($skill[\\u0027value\\u0027]);\\r\\n    $skill_lang = isset($skill-\\u003Elanguage) ? $skill-\\u003Elanguage : $lang;\\r\\n    $stat = isset($this_skill-\\u003Efield_skill_value[$skill_lang][0][\\u0027value\\u0027]) ?\\r\\n      $this_skill-\\u003Efield_skill_value[$skill_lang][0][\\u0027value\\u0027] : 0;\\r\\n    if ($stat \\u003E= $limit) {\\r\\n      $return_value = TRUE;\\r\\n    }\\r\\n  }\\r\\n}\\r\\nreturn $return_value;" } },
        { "OR" : [
            { "data_is" : { "data" : [ "node:field-is-npc" ], "value" : 1 } },
            { "data_is" : { "data" : [ "node:field-is-open-npc" ], "value" : 1 } }
          ]
        }
      ],
      "DO" : [
        { "workflow_rules_set_state" : {
            "node" : [ "node" ],
            "workflow_state" : { "value" : { "4" : "4" } },
            "workflow_comment" : "Passing NPC to approved. All stats and skills under 70. (executed by system:rules:oversight_npc_pass)"
          }
        },
        { "php_eval" : { "code" : "\\u003C?php\\r\\n\\/\\/ Update the timestamp for the latest workflow to avoid a timestamp collision.\\r\\ndb_query(\\u0027UPDATE {workflow_node_history} \\u0027 .\\r\\n  \\u0027SET stamp = stamp+10 \\u0027 .\\r\\n  \\u0027WHERE nid = :nid \\u0027 .\\r\\n  \\u0027ORDER BY hid DESC \\u0027 .\\r\\n  \\u0027LIMIT 1\\u0027,\\r\\n  array(\\u0027:nid\\u0027 =\\u003E $node-\\u003Enid)\\r\\n);\\r\\n?\\u003E" } },
        { "drupal_message" : {
            "message" : "This character has all stat and skills under 70 points. Therefore the character does not require oversight and has been passed along directly to approval.",
            "type" : "warning",
            "repeat" : 0
          }
        }
      ]
    }
  }');
  return $items;
}
