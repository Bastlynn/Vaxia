<?php
/**
 * @file
 * vaxia_evaluation.rules_defaults.inc
 */

/**
 * Implements hook_default_rules_configuration().
 */
function vaxia_evaluation_default_rules_configuration() {
  $items = array();
  $items['items_notify_char_eval_re_new_char'] = entity_import('rules_config', '{ "items_notify_char_eval_re_new_char" : {
      "LABEL" : "Notify char eval re: new char",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Characters" ],
      "REQUIRES" : [ "rules", "workflow_rules", "php" ],
      "ON" : { "workflow_state_changed" : [] },
      "IF" : [
        { "node_is_of_type" : {
            "node" : [ "node" ],
            "type" : { "value" : { "character_sheet" : "character_sheet" } }
          }
        },
        { "workflow_check_transition" : {
            "node" : [ "node" ],
            "old_state" : { "value" : { "ANY" : "ANY" } },
            "new_state" : { "value" : { "3" : "3" } }
          }
        },
        { "workflow_check_state" : { "node" : [ "node" ], "workflow_state" : { "value" : { "3" : "3" } } } },
        { "NOT user_is_blocked" : { "account" : [ "node:author" ] } }
      ],
      "DO" : [
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "3" : "3", "14" : "14" } },
            "subject" : " [Vaxia] A character is ready to be reviewed",
            "message" : "A character is ready to be reviewed.\\r\\n\\r\\nYou are receiving this email because you are one of the people available to evaluate characters.\\r\\n\\r\\nThe player has been notified that it may take up to 72 hours ( \\u003C?php print date(\\u0027m\\/d\\/Y\\u0027, strtotime(\\u0027+1 week\\u0027)); ?\\u003E) before their character begins being addressed by the eval team. It may take much longer still to get the character to a state where it can be approved, especially if it is an Other species or has a Condition, so do not feel pressured to rush into making a decision on a character until you are fully confident that you have addressed any and all concerns with the character details, numbers and skills.\\r\\n\\r\\nIf a single player submits multiple characters on the same day, bear in mind that the 72-hour window does not overlap for the same account - it\\u0027s 72 hours per character (so if they submit three characters, it may take 9 days before the third character is even addressed). We recommend evaluating only one character at a time for a given player. Once that character has been completely addressed and either approved or disapproved, then move on to the next.\\r\\n\\r\\nDon\\u0027t hesitate to contact the System lead(s) or another evaller for a second opinion of you have questions about anything on the character sheet. Just keep the player posted about concerns with their character or any pending approvals from others, such as the Setting Lead(s).\\r\\n\\r\\nIf this character does not meet the requirements to be approved, please revert it to \\u0022draft\\u0022 status and send a Private Message to the player with the details on how to bring it up to an approvable quality.  Copy the same notes into the Workflow Comments when you make the change so that we have a record of it with the item in question.\\r\\n\\r\\nCharacter: [node:title]\\r\\nLink: [node:url]\\r\\nPlayer: [node:author]\\r\\n\\r\\nIf you are not comfortable with approving characters at all, please speak to any of the current heads to update your access privileges.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        },
        { "drupal_message" : { "message" : "Your character [node:title] has been submitted! Our character evaluators have been notified of the new submission and will review the character.  \\r\\n\\r\\nPlease understand that our evaluators are volunteers, and assessing characters is often a diligent process, so it may be up to 72 hours before you hear back.\\r\\n\\r\\nIt may take even longer if you submitted a character with a Condition, or whose race is \\u0022Other,\\u0022 as that requires additional Setting approval above and beyond the normal character evaluation process.  If you have submitted multiple characters within the same 3-day window, each character may require its own 72-hour window for the initial assessment.\\r\\n\\r\\nIf the evaluator has questions or concerns about the character, they will work with you to get them resolved so that the character can be made ready for play.\\r\\n\\r\\nWe appreciate your patience, and hope to get back to you soon about your new character!" } },
        { "data_set" : {
            "data" : [ "node:author:field-characters-submitted" ],
            "value" : {
              "select" : "node:author:field-characters-submitted",
              "num_offset" : { "value" : "1" }
            }
          }
        }
      ]
    }
  }');
  $items['items_notify_player_when_char_approved'] = entity_import('rules_config', '{ "items_notify_player_when_char_approved" : {
      "LABEL" : "Notify player when char approved",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Characters" ],
      "REQUIRES" : [ "rules", "workflow_rules" ],
      "ON" : { "workflow_state_changed" : [] },
      "IF" : [
        { "node_is_of_type" : {
            "node" : [ "node" ],
            "type" : { "value" : { "character_sheet" : "character_sheet" } }
          }
        },
        { "workflow_check_transition" : {
            "node" : [ "node" ],
            "old_state" : { "value" : { "3" : "3" } },
            "new_state" : { "value" : { "4" : "4" } }
          }
        },
        { "NOT user_is_blocked" : { "account" : [ "node:author" ] } }
      ],
      "DO" : [
        { "mail" : {
            "to" : [ "node:author:mail" ],
            "subject" : "[Vaxia] Your character has been approved",
            "message" : "Your character, [node:title], has been approved and is ready to play! \\r\\n\\r\\nYour character was approved with the following notes:\\r\\n\\r\\n[node:workflow-current-state-log-entry]\\r\\n\\r\\n[node:url]\\r\\n\\r\\nIf you have additional questions, please contact: [node:workflow-current-state-updating-user-name]\\r\\n\\r\\nAs you get started with your new character, there are a few things - especially if this is your first one, that you\\u0027ll want to get familiar with.\\r\\n\\r\\n* Care and Feeding for Your Character: http:\\/\\/vaxia.org\\/wiki\\/care-and-feeding-your-character\\r\\n* Vaxia System Walkthrough: http:\\/\\/vaxia.org\\/quizzes\\/new-player-system-walkthrough\\r\\n* Beginner\\u0027s Guide to Roleplaying: http:\\/\\/vaxia.org\\/wiki\\/beginners-guide-roleplaying\\r\\n* Beginner\\u0027s Guide to Sessions: http:\\/\\/vaxia.org\\/wiki\\/beginners-guide-sessions\\r\\n\\r\\nThere are some relevant site policies you want want to look over as well.\\r\\n\\r\\n* Code of Conduct: http:\\/\\/vaxia.org\\/wiki\\/code-conduct\\r\\n* Harassment Policy: http:\\/\\/vaxia.org\\/wiki\\/harassment-policy\\r\\n* Real Life Harm: http:\\/\\/vaxia.org\\/wiki\\/real-life-harm\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ ",
            "language" : [ "" ]
          }
        },
        { "user_add_role" : { "account" : [ "node:author" ], "roles" : { "value" : { "8" : "8" } } } },
        { "user_remove_role" : { "account" : [ "node:author" ], "roles" : { "value" : { "30" : "30" } } } }
      ]
    }
  }');
  $items['items_notify_player_when_char_disapproved'] = entity_import('rules_config', '{ "items_notify_player_when_char_disapproved" : {
      "LABEL" : "Notify player when char returned to draft",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Characters" ],
      "REQUIRES" : [ "rules", "workflow_rules" ],
      "ON" : { "workflow_state_changed" : [] },
      "IF" : [
        { "node_is_of_type" : {
            "node" : [ "node" ],
            "type" : { "value" : { "character_sheet" : "character_sheet" } }
          }
        },
        { "NOT user_is_blocked" : { "account" : [ "node:author" ] } },
        { "workflow_check_transition" : {
            "node" : [ "node" ],
            "old_state" : { "value" : { "3" : "3" } },
            "new_state" : { "value" : { "2" : "2" } }
          }
        }
      ],
      "DO" : [
        { "mail" : {
            "to" : [ "node:author:mail" ],
            "subject" : "[Vaxia] Your new character needs changes made",
            "message" : "Your character, [node:title], has NOT been approved and is NOT ready to play, because there are some remaining changes that need to be made.\\r\\n\\r\\nYour character was returned to draft with the following notes:\\r\\n\\r\\n[node:workflow-current-state-log-entry]\\r\\n\\r\\n[node:url]\\r\\n\\r\\nPlease review the notes for your character (found under the \\u0022Workflow\\u0022 tab) and address any concerns noted there before resubmitting. You may contact the evaluators ( http:\\/\\/vaxia.org\\/sessions\\/storytellers-and-apprentices ) for further assistance in revising your concept.\\r\\n\\r\\nIf you have any questions, please contact: [node:workflow-current-state-updating-user-name]\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ ",
            "language" : [ "" ]
          }
        },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "14" : "14" } },
            "subject" : "[Vaxia] A new character needs changes made",
            "message" : "A character, [node:title], has NOT been approved and is NOT ready to play, because there are some remaining changes that need to be made.\\r\\n\\r\\nThe character was returned to draft with the following notes:\\r\\n\\r\\n[node:workflow-current-state-log-entry]\\r\\n\\r\\n[node:url]\\r\\n\\r\\nIf you have any questions, please contact: [node:workflow-current-state-updating-user-name].\\r\\n\\r\\nYou are receiving this email because you are one of the people available to evaluate characters.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        }
      ]
    }
  }');
  $items['rules_add_character_and_become_a_player'] = entity_import('rules_config', '{ "rules_add_character_and_become_a_player" : {
      "LABEL" : "Add character and become a player",
      "PLUGIN" : "reaction rule",
      "ACTIVE" : false,
      "OWNER" : "rules",
      "TAGS" : [ "Players" ],
      "REQUIRES" : [ "rules" ],
      "ON" : { "node_insert--character_sheet" : { "bundle" : "character_sheet" } },
      "IF" : [
        { "NOT user_has_role" : { "account" : [ "node:author" ], "roles" : { "value" : { "8" : "8" } } } }
      ],
      "DO" : [
        { "user_add_role" : { "account" : [ "node:author" ], "roles" : { "value" : { "8" : "8" } } } },
        { "user_remove_role" : { "account" : [ "node:author" ], "roles" : { "value" : { "30" : "30" } } } }
      ]
    }
  }');
  $items['rules_cap_of_characters_in_the_bin_at_the_same_time'] = entity_import('rules_config', '{ "rules_cap_of_characters_in_the_bin_at_the_same_time" : {
      "LABEL" : "Cap # of characters in the bin at the same time",
      "PLUGIN" : "reaction rule",
      "WEIGHT" : "-5",
      "OWNER" : "rules",
      "TAGS" : [ "Characters" ],
      "REQUIRES" : [ "rules", "workflow_rules", "views_rules", "php" ],
      "ON" : { "workflow_state_changed" : [] },
      "IF" : [
        { "node_is_of_type" : {
            "node" : [ "node" ],
            "type" : { "value" : { "character_sheet" : "character_sheet" } }
          }
        },
        { "workflow_check_transition" : {
            "node" : [ "node" ],
            "old_state" : { "value" : { "1" : "1", "2" : "2" } },
            "new_state" : { "value" : { "3" : "3" } }
          }
        },
        { "data_is" : { "data" : [ "node:field-is-npc" ], "value" : 0 } },
        { "data_is" : { "data" : [ "node:field-is-open-npc" ], "value" : 0 } },
        { "data_is" : { "data" : [ "node:field-is-storyteller" ], "value" : 0 } }
      ],
      "DO" : [
        { "VIEW LOOP" : {
            "VIEW" : "vaxia_character_sheets",
            "DISPLAY" : "eval2",
            "ROW VARIABLES" : [],
            "DO" : [
              { "workflow_rules_set_state" : {
                  "node" : [ "node" ],
                  "workflow_state" : { "value" : { "2" : "2" } },
                  "workflow_comment" : "This character has been returned to draft by the system. Players are limited to submitting only as many characters to the submission bin as there are evaluators available."
                }
              },
              { "php_eval" : { "code" : "db_query(\\u0027UPDATE {workflow_node_history} h \\u0027 .\\r\\n\\u0027SET h.stamp = h.stamp + 1 \\u0027 .\\r\\n\\u0027WHERE h.nid = :nid \\u0027 .\\r\\n\\u0027ORDER BY hid DESC LIMIT 1\\u0027,\\r\\narray(\\u0027:nid\\u0027 =\\u003E $node-\\u003Enid));" } },
              { "drupal_message" : {
                  "message" : "You already have as many characters in the eval bin as we currently have evaluators. To avoid overwhelming the evaluation staff your character has been returned to draft. Once you get one of your other characters approved you can resubmit this character to be evaluated.",
                  "type" : "warning"
                }
              }
            ]
          }
        }
      ]
    }
  }');
  $items['rules_catch_too_many_min_max_characters'] = entity_import('rules_config', '{ "rules_catch_too_many_min_max_characters" : {
      "LABEL" : "Catch too many Min Max characters",
      "PLUGIN" : "reaction rule",
      "WEIGHT" : "-5",
      "OWNER" : "rules",
      "TAGS" : [ "Characters" ],
      "REQUIRES" : [ "rules", "workflow_rules", "php" ],
      "ON" : { "workflow_state_changed" : [] },
      "IF" : [
        { "node_is_of_type" : {
            "node" : [ "node" ],
            "type" : { "value" : { "character_sheet" : "character_sheet" } }
          }
        },
        { "workflow_check_transition" : {
            "node" : [ "node" ],
            "old_state" : { "value" : { "1" : "1", "2" : "2" } },
            "new_state" : { "value" : { "3" : "3" } }
          }
        },
        { "data_is" : { "data" : [ "site:current-user" ], "value" : [ "node:author" ] } },
        { "data_is" : {
            "data" : [ "node:author:field-characters-submitted" ],
            "op" : "\\u003E",
            "value" : "3"
          }
        },
        { "data_is" : {
            "data" : [ "node:author:field-characters-minmax" ],
            "op" : "\\u003E",
            "value" : "0"
          }
        },
        { "data_is" : { "data" : [ "node:field-is-npc" ], "value" : 0 } },
        { "data_is" : { "data" : [ "node:field-is-storyteller" ], "value" : 0 } },
        { "php_eval" : { "code" : "$has_xp = _character_sheet_get_xp($node-\\u003Enid, \\u0027xp\\u0027);\\r\\n\\/\\/ Only run this check if they don\\u0027t have XP.\\r\\nif (!$has_xp) {\\r\\n$messages = _vaxia_check_minmax_flags($node);\\r\\nreturn !empty($messages); \\/\\/ True if messages were flagged.\\r\\n}\\r\\nreturn FALSE;" } },
        { "php_eval" : { "code" : "$mm_chars = [node:author:field-characters-minmax];\\r\\n$chars = [node:author:field-characters-submitted];\\r\\n$perc = $mm_chars \\/ $chars;\\r\\nif ($perc \\u003E 0.5) {\\r\\nreturn TRUE;\\r\\n}\\r\\nreturn FALSE;" } }
      ],
      "DO" : [
        { "workflow_rules_set_state" : {
            "node" : [ "node" ],
            "workflow_state" : { "value" : { "2" : "2" } },
            "workflow_comment" : "This character has been returned to draft by the system. The majority of this player\\u0027s submissions over time have been flagged under the min-max settings. Most characters submitted should not fall under min-max flags."
          }
        },
        { "data_set" : {
            "data" : [ "node:author:field-characters-minmax" ],
            "value" : {
              "select" : "node:author:field-characters-minmax",
              "num_offset" : { "value" : "1" }
            }
          }
        },
        { "data_set" : {
            "data" : [ "node:author:field-characters-submitted" ],
            "value" : {
              "select" : "node:author:field-characters-submitted",
              "num_offset" : { "value" : "-1" }
            }
          }
        },
        { "php_eval" : { "code" : "db_query(\\u0027UPDATE {workflow_node_history} h \\u0027 .\\r\\n\\u0027SET h.stamp = h.stamp + 1 \\u0027 .\\r\\n\\u0027WHERE h.nid = :nid \\u0027 .\\r\\n\\u0027ORDER BY hid DESC LIMIT 1\\u0027,\\r\\narray(\\u0027:nid\\u0027 =\\u003E $node-\\u003Enid));" } },
        { "drupal_message" : {
            "message" : "More than half of your character submissions to date have been flagged under the min-max rules. In order to keep things fair for other players on the site, we will no longer accept min-max builds from your account until you have put in some non-min-maxed builds.",
            "type" : "error"
          }
        }
      ]
    }
  }');
  $items['rules_char_eval_other_and_conditions_under_hxp'] = entity_import('rules_config', '{ "rules_char_eval_other_and_conditions_under_hxp" : {
      "LABEL" : "Catch Other and Condition characters under HXP",
      "PLUGIN" : "reaction rule",
      "WEIGHT" : "-5",
      "OWNER" : "rules",
      "TAGS" : [ "Characters" ],
      "REQUIRES" : [ "rules", "workflow_rules", "php" ],
      "ON" : { "workflow_state_changed" : [] },
      "IF" : [
        { "node_is_of_type" : {
            "node" : [ "node" ],
            "type" : { "value" : { "character_sheet" : "character_sheet" } }
          }
        },
        { "workflow_check_transition" : {
            "node" : [ "node" ],
            "old_state" : { "value" : { "1" : "1", "2" : "2" } },
            "new_state" : { "value" : { "3" : "3" } }
          }
        },
        { "data_is" : {
            "data" : [ "node:author:field-xp-over-time" ],
            "op" : "\\u003C",
            "value" : "41"
          }
        },
        { "data_is" : { "data" : [ "node:field-is-npc" ], "value" : 0 } },
        { "data_is" : { "data" : [ "node:field-is-storyteller" ], "value" : 0 } },
        { "OR" : [
            { "data_is" : { "data" : [ "node:field-race" ], "value" : "other" } },
            { "NOT data_is_empty" : { "data" : [ "node:field-conditions" ] } }
          ]
        }
      ],
      "DO" : [
        { "workflow_rules_set_state" : {
            "node" : [ "node" ],
            "workflow_state" : { "value" : { "2" : "2" } },
            "workflow_comment" : "This character has been returned to draft by the system. The player is under the HXP requirement for playing characters with Species - Other, or Conditions."
          }
        },
        { "php_eval" : { "code" : "db_query(\\u0027UPDATE {workflow_node_history} h \\u0027 .\\r\\n\\u0027SET h.stamp = h.stamp + 1 \\u0027 .\\r\\n\\u0027WHERE h.nid = :nid \\u0027 .\\r\\n\\u0027ORDER BY hid DESC LIMIT 1\\u0027,\\r\\narray(\\u0027:nid\\u0027 =\\u003E $node-\\u003Enid));" } },
        { "drupal_message" : {
            "message" : "This character has a race set to Other or a Condition. These are character concepts that are limited to players with a minimum of 40 HXP. This is to make sure that the player is familiar enough with the community here and the settings they may be playing in to not require too much additional instruction when playing the concept. You do not yet have 40 HXP so we cannot approve this concept yet. Please submit the character when you have hit 40 HXP. You can check your current HXP total on your account information page.",
            "type" : "error"
          }
        }
      ]
    }
  }');
  $items['vaxia_evaluation_notify_player_when_char_workflow'] = entity_import('rules_config', '{ "vaxia_evaluation_notify_player_when_char_workflow" : {
      "LABEL" : "Notify player when char workflow commented",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Characters" ],
      "REQUIRES" : [ "rules", "workflow_rules" ],
      "ON" : { "workflow_comment_added" : [] },
      "IF" : [
        { "node_is_of_type" : {
            "node" : [ "node" ],
            "type" : { "value" : { "character_sheet" : "character_sheet" } }
          }
        },
        { "workflow_check_state" : { "node" : [ "node" ], "workflow_state" : { "value" : { "3" : "3" } } } },
        { "NOT user_is_blocked" : { "account" : [ "node:author" ] } }
      ],
      "DO" : [
        { "drupal_message" : { "message" : "A message with your comment update has been sent to the user." } },
        { "mail" : {
            "to" : [ "node:author:mail" ],
            "subject" : "[Vaxia] Your character has received a workflow comment",
            "message" : "Your character, [node:title], has has received a workflow comment. It is not yet ready to play, nor has it been returned to draft.\\r\\n\\r\\nYour character was updated with the following notes:\\r\\n\\r\\n[node:workflow-current-state-log-entry]\\r\\n\\r\\n[node:url]\\r\\n\\r\\nIf you have additional questions, please contact: [node:workflow-current-state-updating-user-name].\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ ",
            "language" : [ "" ]
          }
        },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "14" : "14" } },
            "subject" : "[Vaxia] A character has received a workflow comment",
            "message" : "A character, [node:title], has has received a workflow comment. It is not yet ready to play, nor has it been returned to draft.\\r\\n\\r\\nThe character was updated with the following notes:\\r\\n\\r\\n[node:workflow-current-state-log-entry]\\r\\n\\r\\n[node:url]\\r\\n\\r\\nIf you have additional questions, please contact: [node:workflow-current-state-updating-user-name].\\r\\n\\r\\nYou are receiving this email because you are one of the people available to evaluate characters.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        }
      ]
    }
  }');
  return $items;
}
