<?php
/**
 * @file
 * anon_mailer.rules_defaults.inc
 */

/**
 * Implements hook_default_rules_configuration().
 */
function anon_mailer_default_rules_configuration() {
  $items = array();
  $items['rules_anon_mailer'] = entity_import('rules_config', '{ "rules_anon_mailer" : {
      "LABEL" : "Anon Mailer",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Anon Mailer" ],
      "REQUIRES" : [ "rules", "webform_rules" ],
      "ON" : { "webform_rules_submit" : [] },
      "IF" : [
        { "node_is_of_type" : { "node" : [ "node" ], "type" : { "value" : { "webform" : "webform" } } } },
        { "data_is" : { "data" : [ "node:nid" ], "value" : "9368" } }
      ],
      "DO" : [
        { "drupal_message" : { "message" : "Your mailing has been forwarded to the current Leads and Technical Admin, stripped of any personally identifying material. Please expect a response on the forums shortly. Please do not tell us who you are! We want to be able to review the issue raised in the mailer with as little bias as possible. If we know who you are, that defeats the purpose." } },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "21" : "21", "3" : "3" } },
            "subject" : "[Vaxia] Anonymous Mailer Submission",
            "message" : "This is a mailing submitted on [site:current-date] through the Anonymous Mailer.\\r\\n\\r\\nThe following information was provided on the mailer:\\r\\n\\r\\n[data:message-value]\\r\\n\\r\\nThe violated principles are: \\r\\n\\r\\n[data:grievance_violation-value]\\r\\n\\r\\nProvided files are: \\r\\n\\r\\n[data:associated_files-value]\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~"
          }
        }
      ]
    }
  }');
  $items['rules_grievance_posting'] = entity_import('rules_config', '{ "rules_grievance_posting" : {
      "LABEL" : "Grievance Posting",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Anon Mailer" ],
      "REQUIRES" : [ "rules", "php", "webform_rules" ],
      "ON" : { "webform_rules_submit" : [] },
      "IF" : [
        { "node_is_of_type" : { "node" : [ "node" ], "type" : { "value" : { "webform" : "webform" } } } },
        { "data_is" : { "data" : [ "node:nid" ], "value" : "9368" } },
        { "php_eval" : { "code" : "$grievance = trim(\\u0022[data:grievance_request-value]\\u0022);\\r\\nwatchdog(\\u0027debug\\u0027, \\u0027.val.\\u0027.$grievance);\\r\\nreturn ($grievance == \\u0027This is a grievance request.\\u0027) ? TRUE: FALSE;" } }
      ],
      "DO" : [
        { "drupal_message" : { "message" : "Thank you, your grievance has been posted to the forums." } },
        { "entity_fetch" : {
            "USING" : { "type" : "user", "id" : "1" },
            "PROVIDE" : { "entity_fetched" : { "admin_user" : "Admin user" } }
          }
        },
        { "entity_create" : {
            "USING" : {
              "type" : "node",
              "param_type" : "forum",
              "param_title" : "Grievance Posting [site:current-date]",
              "param_author" : [ "admin-user" ]
            },
            "PROVIDE" : { "entity_created" : { "entity_created" : "Created entity" } }
          }
        },
        { "data_set" : {
            "data" : [ "entity-created:body:value" ],
            "value" : "\\u003Cb\\u003EThis is a grievance posting submitted on [site:current-date] through the Anonymous Mailer.\\u003C\\/b\\u003E\\r\\n\\r\\n\\u003Cb\\u003EAccording to the rules of the Site Grievance ( http:\\/\\/vaxia.org\\/proposals\\/site-governance ) this posting must be handled publicly.\\u003C\\/b\\u003E\\r\\n\\r\\n\\u003Cb\\u003EThe following information was provided on the mailer:\\u003Cb\\u003E\\r\\n\\r\\n[data:message-value]\\r\\n\\r\\nThe violated principles are: \\r\\n\\r\\n[data:grievance_violation-value]\\r\\n\\r\\nProvided files are: \\r\\n\\r\\n[data:associated_files-value]\\r\\n\\r\\n\\u003Cb\\u003EAll site members are requested to provide any supplemental logs that are relevant to this conversation as quickly as possible. We are seeking to reach a resolution on this matter within two weeks.\\u003C\\/b\\u003E\\r\\n\\r\\n\\u003Cb\\u003EA record of all submitted postings over two-weeks old may be seen at: http:\\/\\/vaxia.org\\/node\\/9368\\/anon-posts\\u003C\\/b\\u003E\\r\\n\\r\\n\\u003Ci\\u003E\\u003Cb\\u003EWhile it is tempting to speculate on the origin of an anonymous mailer, we ask that you not do so. We want the mailer to remain a safe place for anonymous feedback. By speculating, we risk making it feel unsafe for the very people who need it the most.\\u003C\\/bi\\u003E\\u003C\\/i\\u003E\\r\\n\\r\\n\\u003Ci\\u003E\\u003Cb\\u003EIf you are the anon. mailer, please do not tell us! We want to be able to review the issue raised in the mailer with as little bias as possible. If we know who you are, that too defeats the purpose.\\u003C\\/bi\\u003E\\u003C\\/i\\u003E"
          }
        },
        { "data_set" : { "data" : [ "entity-created:body:format" ], "value" : "plain_text" } },
        { "data_set" : { "data" : [ "entity-created:taxonomy-forums" ], "value" : "15" } },
        { "entity_save" : { "data" : [ "entity-created" ] } }
      ]
    }
  }');
  $items['rules_non_grievance_posting'] = entity_import('rules_config', '{ "rules_non_grievance_posting" : {
      "LABEL" : "Non-Grievance Posting",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Anon Mailer" ],
      "REQUIRES" : [ "rules", "php", "webform_rules" ],
      "ON" : { "webform_rules_submit" : [] },
      "IF" : [
        { "node_is_of_type" : { "node" : [ "node" ], "type" : { "value" : { "webform" : "webform" } } } },
        { "data_is" : { "data" : [ "node:nid" ], "value" : "9368" } },
        { "NOT php_eval" : { "code" : "$grievance = trim(\\u0022[data:grievance_request-value]\\u0022);\\r\\nwatchdog(\\u0027debug\\u0027, \\u0027.val.\\u0027.$grievance);\\r\\nreturn ($grievance == \\u0027This is a grievance request.\\u0027) ? TRUE: FALSE;" } }
      ],
      "DO" : [
        { "drupal_message" : { "message" : "Thank you, a notice of your non-grievance mailing has been posted to the forums." } },
        { "entity_fetch" : {
            "USING" : { "type" : "user", "id" : "1" },
            "PROVIDE" : { "entity_fetched" : { "admin_user" : "Admin user" } }
          }
        },
        { "entity_create" : {
            "USING" : {
              "type" : "node",
              "param_type" : "forum",
              "param_title" : "Anonymous Mail Posting [site:current-date]",
              "param_author" : [ "admin-user" ]
            },
            "PROVIDE" : { "entity_created" : { "entity_created" : "Created entity" } }
          }
        },
        { "data_set" : {
            "data" : [ "entity-created:body:value" ],
            "value" : "\\u003Cb\\u003EThis is a notice that an anonymous mailing was submitted on [site:current-date] through the Anonymous Mailer.\\u003C\\/b\\u003E\\r\\n\\r\\n\\u003Cb\\u003EAccording to the rules of the Site Grievance ( http:\\/\\/vaxia.org\\/proposals\\/site-governance ) this posting is NOT a grievance posting and may be handled privately.\\u003C\\/b\\u003E\\r\\n\\r\\n\\u003Cb\\u003EBecause this may be a private matter, the contents of the posting are not immediately available to the site. All involved parties (which may include the site) will be contacted regarding the mailing by the leads. Submissions to the Anon. Mailer should expect a review of the behavior of all involved parties.\\u003C\\/b\\u003E\\r\\n\\r\\n\\u003Cb\\u003EA record of all submitted postings over two-weeks old may be seen at: http:\\/\\/vaxia.org\\/node\\/9368\\/anon-posts\\u003C\\/b\\u003E\\r\\n\\r\\n\\u003Ci\\u003E\\u003Cb\\u003EWhile it is tempting to speculate on the origin of an anonymous mailer, we ask that you not do so. We want the mailer to remain a safe place for anonymous feedback. By speculating, we risk making it feel unsafe for the very people who need it the most.\\u003C\\/bi\\u003E\\u003C\\/i\\u003E\\r\\n\\r\\n\\u003Ci\\u003E\\u003Cb\\u003EIf you are the anon. mailer, please do not tell us! We want to be able to review the issue raised in the mailer with as little bias as possible. If we know who you are, that too defeats the purpose.\\u003C\\/bi\\u003E\\u003C\\/i\\u003E"
          }
        },
        { "data_set" : { "data" : [ "entity-created:body:format" ], "value" : "plain_text" } },
        { "data_set" : { "data" : [ "entity-created:taxonomy-forums" ], "value" : "15" } },
        { "entity_save" : { "data" : [ "entity-created" ] } }
      ]
    }
  }');
  return $items;
}
