<?php
/**
 * @file
 * storyhost_duties.rules_defaults.inc
 */

/**
 * Implements hook_default_rules_configuration().
 */
function storyhost_duties_default_rules_configuration() {
  $items = array();
  $items['rules_rem_priv_roles_when_expired'] = entity_import('rules_config', '{ "rules_rem_priv_roles_when_expired" : {
      "LABEL" : "SH Duties - Remove SH roles if Neglect Duties",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "SH Duties" ],
      "REQUIRES" : [ "rules", "user_stats" ],
      "ON" : { "user_stats_day_older" : [] },
      "IF" : [
        { "user_has_role" : {
            "account" : [ "user" ],
            "roles" : { "value" : { "15" : "15", "9" : "9", "20" : "20", "14" : "14", "21" : "21" } },
            "operation" : "OR"
          }
        },
        { "data_is" : {
            "data" : [ "user:field-powers-expire" ],
            "op" : "\\u003C",
            "value" : "now"
          }
        }
      ],
      "DO" : [
        { "user_remove_role" : {
            "account" : [ "user" ],
            "roles" : { "value" : {
                "13" : "13",
                "10" : "10",
                "17" : "17",
                "15" : "15",
                "9" : "9",
                "20" : "20",
                "14" : "14",
                "21" : "21"
              }
            }
          }
        },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "9" : "9", "14" : "14", "21" : "21" } },
            "subject" : "[Vaxia] [user:name] has lost administrative privileges",
            "message" : "[user:name] has not run required sessions or evaluated characters or items within the required timeframe and has lost all permissions above player as a result.\\r\\n\\r\\nYou are receiving this email because you share some of the same roles, and need to be aware of the changes. If this is a position that needs to be critically filled, please consult with other leadership on the site to recruit or nominate new members to this position as soon as possible.\\r\\n\\r\\nWhile we understand the need to prioritize life over game, we do need members in leadership positions to uphold their responsibilities. [user:name]\\u0027s loss of position due to absence does not preclude re-gaining the position upon return to the site - on the condition that the return is intended to be a long-term return. [user:name] may need to go through the SH course a second time to fully regain permissions.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        },
        { "mail" : {
            "to" : "[user:mail]",
            "subject" : "[Vaxia] You have lost administrative privileges",
            "message" : "[user:name],\\r\\n\\r\\nDespite being listed as active, you have not run sessions or evaluated characters or items within the required timeframe.  As a result, you have automatically lost your privileges as a story host, and been reverted to the role of player.\\r\\n\\r\\nWhile we understand the need for everyone to prioritize life over game, we also need those in the role of evaluator to uphold their responsibilities, including but not limited to running sessions for the site. Your loss of position due to absence does not prevent you from re-gaining the position if and when you return to the site, provided you retake and again complete the SH course, including all tests and session requirements involved.\\r\\n\\r\\nIf you have any questions about the policies on inactive SHs, use the site\\u0027s Contact form or post to the Policies forum to get clarification.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ ",
            "language" : [ "" ]
          }
        }
      ]
    }
  }');
  $items['rules_rem_sh_role_if_absentee_6mo'] = entity_import('rules_config', '{ "rules_rem_sh_role_if_absentee_6mo" : {
      "LABEL" : "SH Duties - Remove SH roles if AWOL",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "SH Duties" ],
      "REQUIRES" : [ "rules", "user_stats" ],
      "ON" : { "user_stats_day_older" : [] },
      "IF" : [
        { "user_has_role" : {
            "account" : [ "user" ],
            "roles" : { "value" : {
                "13" : "13",
                "10" : "10",
                "17" : "17",
                "15" : "15",
                "9" : "9",
                "20" : "20",
                "14" : "14",
                "21" : "21"
              }
            },
            "operation" : "OR"
          }
        },
        { "data_is" : {
            "data" : [ "user:last-access" ],
            "op" : "\\u003C",
            "value" : "-6 months"
          }
        }
      ],
      "DO" : [
        { "user_remove_role" : {
            "account" : [ "user" ],
            "roles" : { "value" : {
                "13" : "13",
                "10" : "10",
                "17" : "17",
                "15" : "15",
                "9" : "9",
                "20" : "20",
                "14" : "14",
                "21" : "21"
              }
            }
          }
        },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "9" : "9", "4" : "4", "3" : "3" } },
            "subject" : "[Vaxia] Administrative privileges lost ",
            "message" : "[user:name] has been absent from the site for 6 months, and has lost all permissions above player as a result.\\r\\n\\r\\nYou are receiving this email because you share some of the same roles, and need to be aware of the changes. If this is a position that needs to be critically filled, please consult with other leadership on the site to recruit or nominate new members to this position.\\r\\n\\r\\nWhile we understand the need to prioritize life over game, we do need members in leadership positions to uphold their responsibilities. [user:name]\\u0027s loss of position due to absence does not preclude re-gaining the position upon return to the site - on the condition that the return is intended to be a long-term return.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        },
        { "mail" : {
            "to" : [ "user:mail" ],
            "subject" : "[Vaxia] Storyhost privileges lost ",
            "message" : "[user:name],\\r\\n\\r\\nDespite being listed as active, you have been completely absent from the site for six months without logging in.  As a result, you have automatically lost your privileges as a story host, and been reverted to the role of player.\\r\\n\\r\\nWhile we understand the need for everyone to prioritize life over game, we also need those in the role of SH to uphold their responsibilities, including but not limited to running sessions for the site. Your loss of position due to absence does not prevent you from re-gaining the position if and when you return to the site, provided you retake and again complete the ASH course, including all tests and session requirements involved therein.\\r\\n\\r\\nSHs aware of sustained absences from the site have the power to set themselves on \\u0022Vacation Mode\\u0022 via their account settings.  Doing so will temporarily suspend your permissions, but you can be reactivated at any time in the future through the same settings pane.\\r\\n\\r\\nIf you have any questions about the policies on inactive SHs, use the site\\u0027s Contact form or post to the Policies forum to get clarification.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ ",
            "language" : [ "" ]
          }
        }
      ]
    }
  }');
  $items['rules_update_expire_on_eval'] = entity_import('rules_config', '{ "rules_update_expire_on_eval" : {
      "LABEL" : "SH Duties - Update power expire on eval char",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "SH Duties" ],
      "REQUIRES" : [ "rules", "workflow_rules" ],
      "ON" : { "workflow_state_changed" : [] },
      "IF" : [
        { "node_is_of_type" : {
            "node" : [ "node" ],
            "type" : { "value" : { "character_sheet" : "character_sheet" } }
          }
        },
        { "NOT data_is" : { "data" : [ "node:author:uid" ], "value" : [ "site:current-user:uid" ] } },
        { "data_is" : { "data" : [ "node:created" ], "op" : "\\u003E", "value" : "-7 days" } },
        { "workflow_check_transition" : {
            "node" : [ "node" ],
            "old_state" : { "value" : { "3" : "3" } },
            "new_state" : { "value" : { "4" : "4" } }
          }
        },
        { "data_is" : {
            "data" : [ "site:current-user:field-powers-expire" ],
            "op" : "\\u003C",
            "value" : "+6 months"
          }
        },
        { "user_has_role" : {
            "account" : [ "site:current-user" ],
            "roles" : { "value" : { "9" : "9" } }
          }
        }
      ],
      "DO" : [
        { "data_set" : {
            "data" : [ "site:current-user:field-powers-expire" ],
            "value" : "+6 months"
          }
        }
      ]
    }
  }');
  $items['rules_update_expire_on_session_creation'] = entity_import('rules_config', '{ "rules_update_expire_on_session_creation" : {
      "LABEL" : "SH Duties - Update power expire on session creation",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "SH Duties" ],
      "REQUIRES" : [ "rules", "php" ],
      "ON" : {
        "node_update--session_report" : { "bundle" : "session_report" },
        "node_insert--session_report" : { "bundle" : "session_report" }
      },
      "IF" : [
        { "data_is" : {
            "data" : [ "node:author:field-powers-expire" ],
            "op" : "\\u003C",
            "value" : "+3 months"
          }
        },
        { "data_is" : { "data" : [ "node:created" ], "op" : "\\u003E", "value" : "-3 days" } },
        { "data_is" : { "data" : [ "node:author:uid" ], "value" : [ "site:current-user:uid" ] } },
        { "php_eval" : { "code" : "return sh_test_session_counts($node);" } },
        { "user_has_role" : { "account" : [ "node:author" ], "roles" : { "value" : { "9" : "9" } } } }
      ],
      "DO" : [
        { "data_set" : { "data" : [ "node:author:field-powers-expire" ], "value" : "+3 months" } }
      ]
    }
  }');
  $items['rules_update_expire_on_session_update'] = entity_import('rules_config', '{ "rules_update_expire_on_session_update" : {
      "LABEL" : "SH Duties - Update power expire on session update",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "SH Duties" ],
      "REQUIRES" : [ "rules", "php" ],
      "ON" : { "node_update--session_report" : { "bundle" : "session_report" } },
      "IF" : [
        { "data_is" : {
            "data" : [ "node:author:field-powers-expire" ],
            "op" : "\\u003C",
            "value" : "+3 months"
          }
        },
        { "data_is" : { "data" : [ "node:created" ], "op" : "\\u003E", "value" : "-3 days" } },
        { "data_is" : { "data" : [ "node:author:uid" ], "value" : [ "site:current-user:uid" ] } },
        { "php_eval" : { "code" : "return sh_test_session_counts($node);" } },
        { "user_has_role" : { "account" : [ "node:author" ], "roles" : { "value" : { "9" : "9" } } } }
      ],
      "DO" : [
        { "data_set" : { "data" : [ "node:author:field-powers-expire" ], "value" : "+3 months" } }
      ]
    }
  }');
  $items['sh_test_update_expire_on_eval_item'] = entity_import('rules_config', '{ "sh_test_update_expire_on_eval_item" : {
      "LABEL" : "SH Duties - Update power expire on eval item",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "SH Duties" ],
      "REQUIRES" : [ "rules", "workflow_rules" ],
      "ON" : { "workflow_state_changed" : [] },
      "IF" : [
        { "node_is_of_type" : { "node" : [ "node" ], "type" : { "value" : { "items" : "items" } } } },
        { "NOT data_is" : { "data" : [ "node:author:uid" ], "value" : [ "site:current-user:uid" ] } },
        { "data_is" : { "data" : [ "node:created" ], "op" : "\\u003E", "value" : "-7 days" } },
        { "workflow_check_transition" : {
            "node" : [ "node" ],
            "old_state" : { "value" : { "14" : "14" } },
            "new_state" : { "value" : { "15" : "15" } }
          }
        },
        { "data_is" : {
            "data" : [ "site:current-user:field-powers-expire" ],
            "op" : "\\u003C",
            "value" : "+6 months"
          }
        },
        { "user_has_role" : {
            "account" : [ "site:current-user" ],
            "roles" : { "value" : { "9" : "9" } }
          }
        }
      ],
      "DO" : [
        { "data_set" : {
            "data" : [ "site:current-user:field-powers-expire" ],
            "value" : "+6 months"
          }
        }
      ]
    }
  }');
  return $items;
}
