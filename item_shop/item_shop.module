<?php
/**
 * @file
 * Code for the Item shop feature.
 */

include_once 'item_shop.features.inc';

/**
 * Implements hook_permission().
 */
function item_shop_permission() {
  return array(
    'use item shop' => array(
      'title' => t('use item shop'),
      'description' => t('Use item shop.'),
    ),
    'set item for shop' => array(
      'title' => t('set item for shop'),
      'description' => t('Set item for shop.'),
    ),
    'administer item shop' => array(
      'title' => t('administer item shop'),
      'description' => t('Administer item shop.'),
    ),
  );
}

/**
 * Implements hook_menu_alter().
 */
function item_shop_menu_alter(&$items) {
  // Set a custom access callback function for our view page display path.
  $items['node/%/item_shop']['access callback'] = '_item_shop_access_callback';
}

/**
 * Implements hook_module_implements_alter().
 */
function item_shop_module_implements_alter(&$implementations, $hook) {
  // When the implementations of hook_menu_alter are called, we need our module
  // to be called after views, so let's remove it from the implementations then
  // add it to the end.
  if ($hook == 'menu_alter') {
    if (isset($implementations['item_shop'])) {
      unset($implementations['item_shop']);
      $implementations['item_shop'] = FALSE;
    }
  }
}

/**
 * A custom 'access callback' function used by our view page display
 * to determine if its local task menu tab should show up or not.
 */
function _item_shop_access_callback($options = array()) {
  // Grab the default access callback function name, prepare the access
  // arguments, then see what the default access call back result is
  // according to views.
  $access_callback = $options[0];
  $access_arguments = $options[1];
  $access = call_user_func_array($access_callback, $access_arguments);

  // If the default access call back was false, then the user is not allowed
  // access.
  if (!$access) {
    return FALSE;
  }

  // So far the user is allowed access from the views' settings, let's now
  // determine if we want to customize the access to the tab.
  // If the node type is not an article, then we'll deny access, otherwise grant
  // access. 
  $node = node_load(arg(1));
  if ($node && $node->type != 'character_sheet') {
    return FALSE;
  }
  else {
    return TRUE; 
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function item_shop_form_views_form_item_shop_item_shop_alter(&$form, &$form_state, $form_id) {
  // Change text.
  $form['actions']['submit']['#value'] = t('Purchase items');
  // Change acess.
  global $user;
  $node = node_load(arg(1));
  if ($user->uid != $node->uid) {
    $form['actions']['submit']['#disabled'] = TRUE;
    $form['actions']['submit']['#value'] = t('This is not your character sheet');     
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function item_shop_form_items_node_form_alter(&$form, &$form_state, $form_id) {
  if (!user_access('set item for shop')) {
    $form['field_in_shop']['#access'] = FALSE;
    $form['field_in_shop']['#value'] = isset($form['field_in_shop']['#default_value']) ? $form['field_in_shop']['#default_value'] : 0;
  }
}

/**
 * Helper for views. Check if this character can afford this item.
 */
function item_shop_check_can_afford($nid) {
  // Get argument - character node.
  $character = node_load(arg(1));
  $lang = $character->language;
  // Get char from argument.
  $char = isset($character->nid) ? $character->nid : '';
  // Check values are ok.
  if (empty($char)) {
    return TRUE;
  }
  // Get realm from argument.
  $realm = isset($character->field_realm[$lang][0]['value']) ? $character->field_realm[$lang][0]['value'] : 'Vaxia';
  // Check values are ok.
  if (empty($realm)) {
    return TRUE;
  }
  // Get available silver from character.
  $silver = _character_sheet_get_xp($character->nid, 'silver');
  $silver_spent = _character_sheet_get_xp($character->nid, 'spent_silver');
  $silver_invested = _character_sheet_get_xp($character->nid, 'invest_silver');
  $available_silver = $silver - ($silver_spent + $silver_invested);
  // Available economy.
  $economy = isset($character->field_economy[$lang][0]['value']) ? $character->field_economy[$lang][0]['value'] : 0;
  $worth = _vaxia_calculate_worth($economy);
  // Grand total available.
  $total_worth = $available_silver + $worth;
  $silver = isset($total_worth) ? $total_worth : 0;
  // Check values are ok.
  if (empty($silver)) {
    return TRUE;
  }
  // Check the silver value for this item.
  $item = node_load($nid);
  $lang = $item->language;
  $this_value = $item->field_value[$lang][0]['value'];
  $this_value = str_replace(',', '', $this_value);
  $this_value = str_replace('.', '', $this_value);
  // Execute the checks.
  // If the code returns TRUE the current row is removed from the results.
  if (!is_numeric($this_value)) {
    return TRUE;
  }
  if ($silver < $this_value) {
    return TRUE;
  }
  $this_realm = isset($item->field_realm[$lang][0]['value']) ? $item->field_realm[$lang][0]['value'] : 'Vaxia';
  if ($realm != $this_realm) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Helper for views. Check if this character can afford this item.
 */
function item_shop_check_already_has($nid) {
  // Get argument - character node.
  $character = node_load(arg(1));
  $lang = $character->language;
  // Get items from character.
  $has_items = array();
  foreach ($character->field_items[$lang] as $info) {
    $this_item = node_load($info['nid']);
    $has_items[] = $this_item->title;
  }
  // Execute the check.
  // If the code returns TRUE the current row is removed from the results.
  $item = node_load($nid);
  if (in_array($item->title, $has_items)) {
    return TRUE;
  }
  return FALSE;
}