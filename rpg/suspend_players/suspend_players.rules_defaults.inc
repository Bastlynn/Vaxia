<?php
/**
 * @file
 * suspend_players.rules_defaults.inc
 */

/**
 * Implements hook_default_rules_configuration().
 */
function suspend_players_default_rules_configuration() {
  $items = array();
  $items['rules_unban_a_banned_user'] = entity_import('rules_config', '{ "rules_unban_a_banned_user" : {
      "LABEL" : "Suspend - Unblock a suspended user",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Suspend Players" ],
      "REQUIRES" : [ "rules", "user_stats" ],
      "ON" : { "user_stats_day_older" : [] },
      "IF" : [
        { "user_has_role" : { "account" : [ "user" ], "roles" : { "value" : { "32" : "32" } } } },
        { "user_is_blocked" : { "account" : [ "user" ] } },
        { "NOT data_is_empty" : { "data" : [ "user:field-banned-until" ] } },
        { "data_is" : {
            "data" : [ "user:field-banned-until" ],
            "op" : "\\u003C",
            "value" : "now"
          }
        }
      ],
      "DO" : [
        { "user_add_role" : { "account" : [ "user" ], "roles" : { "value" : { "8" : "8" } } } },
        { "user_remove_role" : { "account" : [ "user" ], "roles" : { "value" : { "32" : "32" } } } },
        { "user_unblock" : { "account" : [ "user" ] } },
        { "data_set" : { "data" : [ "user:field-banned-until" ] } },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "3" : "3", "21" : "21" } },
            "subject" : "[Vaxia] [user:name] has been unbanned",
            "message" : "[user:name] has been unbanned.\\r\\n\\r\\nThis email is to let you know that the account has been unbanned. By becoming unbanned, this player\\u0027s characters have been taken out of cold storage and put into draft for resubmission and review by evaluation staff.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will\\r\\nnot be received by a human.\\r\\n~~~~~~"
          }
        },
        { "mail" : {
            "to" : [ "user:mail" ],
            "subject" : "[Vaxia] Your ban has been lifted",
            "message" : "Your ban has been lifted.\\r\\n\\r\\nThis email is to let you know that your account has been unbanned. By becoming unbanned, your characters have been taken out of cold storage and put into draft for resubmission and review by evaluation staff.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will\\r\\nnot be received by a human.\\r\\n~~~~~~",
            "language" : [ "" ]
          }
        }
      ]
    }
  }');
  $items['strikes_strikes_third_yellow_strike'] = entity_import('rules_config', '{ "strikes_strikes_third_yellow_strike" : {
      "LABEL" : "Suspend - 3rd yellow strike ",
      "PLUGIN" : "reaction rule",
      "WEIGHT" : "5",
      "OWNER" : "rules",
      "TAGS" : [ "Suspend Players" ],
      "REQUIRES" : [ "rules", "views_rules" ],
      "ON" : { "node_insert--strike" : { "bundle" : "strike" } },
      "IF" : [
        { "node_is_of_type" : { "node" : [ "node" ], "type" : { "value" : { "strike" : "strike" } } } },
        { "data_is" : { "data" : [ "node:field-severity" ], "value" : "Yellow" } },
        { "entity_is_of_bundle" : {
            "entity" : [ "node:field-associated-record" ],
            "type" : "node",
            "bundle" : { "value" : { "notation" : "notation" } }
          }
        }
      ],
      "DO" : [
        { "entity_save" : { "data" : [ "node" ], "immediate" : 1 } },
        { "VIEW LOOP" : {
            "VIEW" : "suspensions",
            "DISPLAY" : "check_yellows",
            "USING" : { "field_struck_player_uid" : [ "node:field-struck-player:uid" ] },
            "ROW VARIABLES" : { "yellow_count" : { "yellow_count" : "Yellow count" } },
            "DO" : [
              { "mail_to_users_of_role" : {
                  "roles" : { "value" : { "21" : "21", "29" : "29" } },
                  "subject" : "[Vaxia] A Yellow strike has upgraded to a Red strike for [node:field-struck-player:name]",
                  "message" : "A yellow strike has been issued against [node:field-struck-player:name].\\r\\n\\r\\nThey have received more than three yellow strikes within the last year, therefore a red strike has also been issued.\\r\\n\\r\\nIf you have more information to provide to the situation please contact [node:author] to add your documentation. Further questions, concerns, or challenges to this strike should also be directed to [node:author] and to the SH body as a whole.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
                }
              },
              { "entity_create" : {
                  "USING" : {
                    "type" : "node",
                    "param_type" : "strike",
                    "param_title" : "Red strike - [node:field-struck-player:name]",
                    "param_author" : [ "node:author" ]
                  },
                  "PROVIDE" : { "entity_created" : { "red_strike" : "Red strike" } }
                }
              },
              { "data_set" : { "data" : [ "node:field-associated-record" ], "value" : [ "node" ] } },
              { "data_set" : { "data" : [ "red-strike:field-date-of-incident" ], "value" : "now" } },
              { "data_set" : {
                  "data" : [ "red-strike:field-struck-player" ],
                  "value" : [ "node:field-struck-player" ]
                }
              },
              { "data_set" : { "data" : [ "red-strike:field-severity" ], "value" : "Red" } },
              { "list_add" : {
                  "list" : [ "node:field-associated-record:field-red-strike" ],
                  "item" : [ "node:field-struck-player" ],
                  "unique" : 1
                }
              },
              { "list_add" : {
                  "list" : [ "node:field-associated-record:field-results" ],
                  "item" : "red",
                  "unique" : 1
                }
              },
              { "entity_save" : { "data" : [ "red-strike" ] } },
              { "entity_save" : { "data" : [ "node:field-associated-record" ] } }
            ]
          }
        }
      ]
    }
  }');
  $items['strikes_suspend_player'] = entity_import('rules_config', '{ "strikes_suspend_player" : {
      "LABEL" : "Suspend - Red Strike",
      "PLUGIN" : "reaction rule",
      "WEIGHT" : "5",
      "OWNER" : "rules",
      "TAGS" : [ "Suspend Players" ],
      "REQUIRES" : [ "rules", "views_rules" ],
      "ON" : { "node_insert--strike" : { "bundle" : "strike" } },
      "IF" : [
        { "node_is_of_type" : { "node" : [ "node" ], "type" : { "value" : { "strike" : "strike" } } } },
        { "data_is" : { "data" : [ "node:field-severity" ], "value" : "Red" } }
      ],
      "DO" : [
        { "entity_save" : { "data" : [ "node" ], "immediate" : 1 } },
        { "VIEW LOOP" : {
            "VIEW" : "suspensions",
            "DISPLAY" : "check_reds",
            "USING" : { "field_struck_player_uid" : [ "node:field-struck-player:uid" ] },
            "ROW VARIABLES" : {
              "red_count" : { "red_count" : "Red count" },
              "new_ban_months" : { "new_ban_months" : "New ban months" },
              "new_ban" : { "new_ban" : "New Ban" }
            },
            "DO" : [
              { "data_set" : {
                  "data" : [ "node:field-struck-player:field-banned-until" ],
                  "value" : [ "new-ban" ]
                }
              },
              { "entity_save" : { "data" : [ "node:field-struck-player" ], "immediate" : 1 } },
              { "user_remove_role" : {
                  "account" : [ "node:field-struck-player" ],
                  "roles" : { "value" : {
                      "3" : "3",
                      "30" : "30",
                      "8" : "8",
                      "9" : "9",
                      "14" : "14",
                      "21" : "21",
                      "24" : "24",
                      "26" : "26",
                      "27" : "27",
                      "19" : "19",
                      "28" : "28",
                      "29" : "29",
                      "12" : "12",
                      "25" : "25",
                      "13" : "13",
                      "10" : "10",
                      "17" : "17",
                      "15" : "15",
                      "20" : "20",
                      "22" : "22",
                      "23" : "23",
                      "31" : "31",
                      "32" : "32"
                    }
                  }
                }
              },
              { "user_add_role" : {
                  "account" : [ "node:field-struck-player" ],
                  "roles" : { "value" : { "32" : "32" } }
                }
              },
              { "user_block" : { "account" : [ "node:field-struck-player" ] } }
            ]
          }
        }
      ]
    }
  }');
  return $items;
}
