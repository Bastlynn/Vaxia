<?php
/**
 * @file
 * vaxia_accounts.rules_defaults.inc
 */

/**
 * Implements hook_default_rules_configuration().
 */
function vaxia_accounts_default_rules_configuration() {
  $items = array();
  $items['rules_red_strike'] = entity_import('rules_config', '{ "rules_red_strike" : {
      "LABEL" : "Red strike",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Vaxia Reputation" ],
      "REQUIRES" : [ "rules", "php", "userpoints_rules" ],
      "ON" : { "node_insert" : [] },
      "IF" : [
        { "node_is_of_type" : { "node" : [ "node" ], "type" : { "value" : { "strike" : "strike" } } } },
        { "data_is" : {
            "data" : [ "node:field-severity" ],
            "value" : "Red - severe warning (suspension)"
          }
        }
      ],
      "DO" : [
        { "entity_fetch" : {
            "USING" : { "type" : "user", "id" : [ "node:field-player:uid" ] },
            "PROVIDE" : { "entity_fetched" : { "entity_fetched" : "Striked user" } }
          }
        },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "3" : "3", "9" : "9", "4" : "4" } },
            "subject" : "[Vaxia] A red strike has been issued",
            "message" : "A red strike has been issued against [entity-fetched:name].\\r\\n\\r\\nPlease review the details at [node:url] , so that you are familar with the circumstances.\\r\\n\\r\\nIf you have more information to provide to the situation please contact [node:author] to add your documentation. Further questions, concerns, or challenges to this strike should also be directed to [node:author] and to the SH body as a whole.\\r\\n\\r\\nAs a red strike, [entity-fetched:name] is banned from the site until \\u003C?php print date(\\u0027m\\/d\\/Y\\u0027, strtotime(\\u0027+1 month\\u0027)); ?\\u003E.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        },
        { "mail" : {
            "to" : "[entity-fetched:mail]",
            "subject" : "[Vaxia] A red strike has been issued against you",
            "message" : "A red strike has been issued against you.\\r\\n\\r\\nPlease review the details at [node:url] , so that you are familar with the circumstances.\\r\\n\\r\\nFurther questions, concerns, or challenges to this strike should also be directed to [node:author] and to the SH body as a whole.\\r\\n\\r\\nAs a red strike, you are banned from the site until \\u003C?php print date(\\u0027m\\/d\\/Y\\u0027, strtotime(\\u0027+1 month\\u0027)); ?\\u003E.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ ",
            "language" : [ "" ]
          }
        },
        { "user_block" : { "account" : [ "entity-fetched" ] } },
        { "userpoints_action_grant_points" : {
            "user" : [ "entity-fetched" ],
            "points" : "-10",
            "tid" : "0",
            "entity" : [ "" ],
            "description" : "-10 v-rep for a strike.",
            "operation" : "Remove",
            "display" : 0,
            "moderate" : "approved"
          }
        }
      ]
    }
  }');
  $items['rules_rem_priv_roles_if_no_run_3mo'] = entity_import('rules_config', '{ "rules_rem_priv_roles_if_no_run_3mo" : {
      "LABEL" : "Rem priv roles if no-run 3mo",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Positions" ],
      "REQUIRES" : [ "rules", "php", "user_stats" ],
      "ON" : { "user_stats_day_older" : [] },
      "IF" : [
        { "user_has_role" : { "account" : [ "user" ], "roles" : { "value" : { "9" : "9" } } } },
        { "NOT user_has_role" : {
            "account" : [ "user" ],
            "roles" : { "value" : { "14" : "14" } },
            "operation" : "OR"
          }
        },
        { "data_is" : {
            "data" : [ "user:created" ],
            "op" : "\\u003C",
            "value" : { "select" : "site:current-date", "date_offset" : { "value" : -7776000 } }
          }
        },
        { "php_eval" : { "code" : "$nodes = node_load_multiple(array(), array(\\u0027type\\u0027 =\\u003E \\u0027session_report\\u0027, \\u0027uid\\u0027 =\\u003E $user-\\u003Euid ));\\r\\nforeach ($nodes as $node) {\\r\\n  $timespan = strtotime(\\u0027-3 months\\u0027);\\r\\n  if ($node-\\u003Estatus == 1 \\u0026\\u0026 $node-\\u003Ecreated \\u003E= $timespan) {\\r\\n    return FALSE;\\r\\n  }\\r\\n}\\r\\nreturn TRUE;" } }
      ],
      "DO" : [
        { "user_remove_role" : {
            "account" : [ "user" ],
            "roles" : { "value" : { "13" : "13", "10" : "10", "15" : "15", "9" : "9", "14" : "14" } }
          }
        },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "9" : "9", "4" : "4", "3" : "3" } },
            "subject" : "[Vaxia] Storyhost privileges lost ",
            "message" : "SHs,\\r\\n\\r\\nDespite being listed as active, [user:name] has not run a session in three month\\u0027s time.  As a result, they have automatically lost their privileges as a story host, and been reverted to the role of player. As a fellow SH, you are receiving this email so that you can be aware of the change and the reason behind it.\\r\\n\\r\\nWhile we understand the need for everyone to prioritize life over game, we also need those in the role of SH to uphold their responsibilities, including but not limited to running sessions for the site. [user:name]\\u0027s loss of position due to absence does not prevent them from re-gaining the position if and when they return to the site, provided they retake and again complete the ASH course, including all tests and session requirements involved therein.\\r\\n\\r\\nSHs aware of sustained absences from the site have the power to set themselves on \\u0022Vacation Mode\\u0022 via their account settings.  Doing so will temporarily suspend their permissions, but they can be reactivated at any time in the future through the same settings pane.\\r\\n\\r\\nIf you have any questions about [user:name] \\u0027s absence or the policies on inactive SHs, use the site\\u0027s Contact form or post to the Policies forum to get clarification.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        },
        { "mail" : {
            "to" : [ "user:mail" ],
            "subject" : "[Vaxia] Storyhost privileges lost ",
            "message" : "[user:name],\\r\\n\\r\\nDespite being listed as active, you have not run a session in three month\\u0027s time.  As a result, you have automatically lost your privileges as a story host, and been reverted to the role of player.\\r\\n\\r\\nWhile we understand the need for everyone to prioritize life over game, we also need those in the role of SH to uphold their responsibilities, including but not limited to running sessions for the site. Your loss of position due to absence does not prevent you from re-gaining the position if and when you return to the site, provided you retake and again complete the ASH course, including all tests and session requirements involved therein.\\r\\n\\r\\nSHs aware of sustained absences from the site have the power to set themselves on \\u0022Vacation Mode\\u0022 via their account settings.  Doing so will temporarily suspend your permissions, but you can be reactivated at any time in the future through the same settings pane.\\r\\n\\r\\nIf you have any questions about the policies on inactive SHs, use the site\\u0027s Contact form or post to the Policies forum to get clarification.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ ",
            "language" : [ "" ]
          }
        }
      ]
    }
  }');
  $items['rules_rem_priv_roles_if_no_run_6mo'] = entity_import('rules_config', '{ "rules_rem_priv_roles_if_no_run_6mo" : {
      "LABEL" : "Rem priv roles if no-run 6mo",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Positions" ],
      "REQUIRES" : [ "rules", "php", "user_stats" ],
      "ON" : { "user_stats_day_older" : [] },
      "IF" : [
        { "user_has_role" : {
            "account" : [ "user" ],
            "roles" : { "value" : { "9" : "9", "14" : "14" } }
          }
        },
        { "data_is" : {
            "data" : [ "user:created" ],
            "op" : "\\u003C",
            "value" : {
              "select" : "site:current-date",
              "date_offset" : { "value" : -15552000 }
            }
          }
        },
        { "php_eval" : { "code" : "$nodes = node_load_multiple(array(), array(\\u0027type\\u0027 =\\u003E \\u0027session_report\\u0027, \\u0027uid\\u0027 =\\u003E $user-\\u003Euid ));\\r\\nforeach ($nodes as $node) {\\r\\n  $timespan = strtotime(\\u0027-6 months\\u0027);\\r\\n  if ($node-\\u003Estatus == 1 \\u0026\\u0026 $node-\\u003Ecreated \\u003E= $timespan) {\\r\\n    return FALSE;\\r\\n  }\\r\\n}\\r\\nreturn TRUE;" } }
      ],
      "DO" : [
        { "user_remove_role" : { "account" : [ "user" ], "roles" : { "value" : { "9" : "9" } } } },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "9" : "9", "4" : "4", "3" : "3" } },
            "subject" : "[Vaxia] Administrative privileges lost ",
            "message" : "[user:name] has been absent from the site for 6 months, and has lost all permissions above player as a result.\\r\\n\\r\\nYou are receiving this email because you share some of the same roles, and need to be aware of the changes. If this is a position that needs to be critically filled, please consult with other leadership on the site to recruit or nominate new members to this position.\\r\\n\\r\\nWhile we understand the need to prioritize life over game, we do need members in leadership positions to uphold their responsibilities. [user:name]\\u0027s loss of position due to absence does not preclude re-gaining the position upon return to the site - on the condition that the return is intended to be a long-term return.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        }
      ]
    }
  }');
  $items['rules_rem_sh_role_if_absentee_6mo'] = entity_import('rules_config', '{ "rules_rem_sh_role_if_absentee_6mo" : {
      "LABEL" : "Rem priv roles if absentee 3mo",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Positions" ],
      "REQUIRES" : [ "rules", "user_stats" ],
      "ON" : { "user_stats_day_older" : [] },
      "IF" : [
        { "user_has_role" : {
            "account" : [ "user" ],
            "roles" : { "value" : { "9" : "9", "10" : "10", "7" : "7", "4" : "4", "11" : "11" } },
            "operation" : "OR"
          }
        },
        { "data_is" : {
            "data" : [ "user:last-access" ],
            "op" : "\\u003C",
            "value" : { "select" : "site:current-date", "date_offset" : { "value" : -7776000 } }
          }
        }
      ],
      "DO" : [
        { "user_remove_role" : {
            "account" : [ "user" ],
            "roles" : { "value" : { "9" : "9", "10" : "10", "7" : "7", "4" : "4", "11" : "11" } }
          }
        },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "3" : "3", "9" : "9", "7" : "7", "4" : "4" } },
            "subject" : "[Vaxia] Administrative privileges lost ",
            "message" : "[user:name] has been absent from the site for 3 months, and has lost all permissions above player as a result.\\r\\n\\r\\nYou are receiving this email because you share some of the same roles, and need to be aware of the changes. If this is a position that needs to be critically filled, please consult with other leadership on the site to recruit or nominate new members to this position.\\r\\n\\r\\nWhile we understand the need to prioritize life over game, we do need members in leadership positions to uphold their responsibilities. [user:name]\\u0027s loss of position due to absence does not preclude re-gaining the position upon return to the site - on the condition that the return is intended to be a long-term return.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        }
      ]
    }
  }');
  $items['rules_retire_inactive_user_account'] = entity_import('rules_config', '{ "rules_retire_inactive_user_account" : {
      "LABEL" : "Retire inactive user account",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Retire" ],
      "REQUIRES" : [ "rules", "user_stats" ],
      "ON" : { "user_stats_day_older" : [] },
      "IF" : [
        { "NOT user_is_blocked" : { "account" : [ "user" ] } },
        { "data_is" : {
            "data" : [ "user:created" ],
            "op" : "\\u003C",
            "value" : {
              "select" : "site:current-date",
              "date_offset" : { "value" : -31104000 }
            }
          }
        },
        { "data_is" : {
            "data" : [ "user:last-access" ],
            "op" : "\\u003C",
            "value" : {
              "select" : "site:current-date",
              "date_offset" : { "value" : -31536000 }
            }
          }
        }
      ],
      "DO" : [
        { "mail" : {
            "to" : "bastlynn@gmail.com",
            "subject" : "[Vaxia] User blocked for inactivity [user:name]",
            "message" : "User blocked for inactivity for 1 yr on: [user:name]  - last access: [user:last-access]",
            "language" : [ "" ]
          }
        },
        { "user_block" : { "account" : [ "user" ] } }
      ]
    }
  }');
  $items['rules_retire_unused_user_account'] = entity_import('rules_config', '{ "rules_retire_unused_user_account" : {
      "LABEL" : "Delete unused user account",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Retire" ],
      "REQUIRES" : [ "rules", "user_stats" ],
      "ON" : { "user_stats_day_older" : [] },
      "IF" : [
        { "NOT user_is_blocked" : { "account" : [ "user" ] } },
        { "NOT user_has_role" : {
            "account" : [ "user" ],
            "roles" : { "value" : { "8" : "8" } },
            "operation" : "OR"
          }
        },
        { "data_is" : {
            "data" : [ "user:created" ],
            "op" : "\\u003C",
            "value" : { "select" : "site:current-date", "date_offset" : { "value" : -259200 } }
          }
        },
        { "data_is_empty" : { "data" : [ "user:last-login" ] } }
      ],
      "DO" : [
        { "entity_delete" : { "data" : [ "user" ] } },
        { "mail" : {
            "to" : "bastlynn@gmail.com",
            "subject" : "[Vaxia] User deleted [user:name]",
            "message" : "[Vaxia] User deleted [user:name]",
            "language" : [ "" ]
          }
        }
      ]
    }
  }');
  $items['rules_vacation_end'] = entity_import('rules_config', '{ "rules_vacation_end" : {
      "LABEL" : "Vacation end",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Positions" ],
      "REQUIRES" : [ "rules", "vaxia_vacation" ],
      "ON" : { "vaxia_vacation_end" : [] },
      "DO" : [
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "9" : "9", "4" : "4" } },
            "subject" : "[Vaxia] Storyhost or ASH has returned from vacation",
            "message" : "[user:name] has returned from a long-term vacation using the Vaxian vacation mode system. This email is to notify you to welcome this player back.\\r\\n\\r\\n[user:name]\\u0027s permissions have been re-enabled as they were before they left, and they are ready to fulfil those roles.\\r\\n\\r\\nIf you have any questions about [user:name] \\u0027s absence or the policies on inactive SHs, use the site\\u0027s Contact form or post to the Policies forum to get clarification.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        },
        { "redirect" : { "url" : "\\u003Cfront\\u003E" } },
        { "drupal_message" : { "message" : "Welcome back! Take a moment to check in with the rest of the Storyhosts so you know what you missed. If you\\u0027ve been gone for a long time - expect to have to do some catching up." } }
      ]
    }
  }');
  $items['rules_vacation_start'] = entity_import('rules_config', '{ "rules_vacation_start" : {
      "LABEL" : "Vacation start",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Positions" ],
      "REQUIRES" : [ "rules", "vaxia_vacation" ],
      "ON" : { "vaxia_vacation_start" : [] },
      "DO" : [
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "9" : "9", "4" : "4" } },
            "subject" : "[Vaxia] Storyhost or ASH has gone on vacation",
            "message" : "[user:name] has gone on a long-term vacation using the Vaxian vacation mode system. This email is to notify you to expect a long term vacation or absence on behalf of this player.\\r\\n\\r\\nWhile on vacation, [user:name] will only have permissions and access as per a player. They will not have any SH or ASH powers and will not be receiving any notices relevant to those roles.\\r\\n\\r\\nOnce [user:name] declares themselves off of vacation, the permissions will be re-enabled and they will be available to continue in the previous roles.\\r\\n\\r\\nIf you have any questions about [user:name]\\u0027s absence or the policies on inactive SHs, use the site\\u0027s Contact form or post to the Policies forum to get clarification.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        },
        { "redirect" : { "url" : "\\u003Cfront\\u003E" } },
        { "drupal_message" : { "message" : "Your vacation notice has gone out, roles have been removed and you are ready to hit the beach and\\/or deal with what you need to. Good luck, and we\\u0027ll see you again when you\\u0027re ready to return." } }
      ]
    }
  }');
  $items['rules_yellow_strike'] = entity_import('rules_config', '{ "rules_yellow_strike" : {
      "LABEL" : "Yellow strike",
      "PLUGIN" : "reaction rule",
      "OWNER" : "rules",
      "TAGS" : [ "Vaxia Reputation" ],
      "REQUIRES" : [ "rules", "userpoints_rules" ],
      "ON" : { "node_insert" : [] },
      "IF" : [
        { "node_is_of_type" : { "node" : [ "node" ], "type" : { "value" : { "strike" : "strike" } } } },
        { "data_is" : {
            "data" : [ "node:field-severity" ],
            "value" : "Yellow - moderate warning"
          }
        }
      ],
      "DO" : [
        { "entity_fetch" : {
            "USING" : { "type" : "user", "id" : [ "node:field-player:uid" ] },
            "PROVIDE" : { "entity_fetched" : { "entity_fetched" : "Striked user" } }
          }
        },
        { "mail_to_users_of_role" : {
            "roles" : { "value" : { "3" : "3", "9" : "9", "4" : "4" } },
            "subject" : "[Vaxia] A yellow strike has been issued",
            "message" : "A yellow strike has been issued against [entity-fetched:name].\\r\\n\\r\\nPlease review the details at [node:url] , so that you are familar with the circumstances.\\r\\n\\r\\nIf you have more information to provide to the situation please contact [node:author] to add your documentation. Further questions, concerns, or challenges to this strike should also be directed to [node:author] and to the SH body as a whole.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ "
          }
        },
        { "mail" : {
            "to" : "[entity-fetched:mail]",
            "subject" : "[Vaxia] A yellow strike has been issued against you",
            "message" : "A yellow strike has been issued against you.\\r\\n\\r\\nPlease review the details at [node:url] , so that you are familar with the circumstances.\\r\\n\\r\\nFurther questions, concerns, or challenges to this strike should also be directed to [node:author] and to the SH body as a whole.\\r\\n\\r\\n~~~~~~\\r\\nThis email was automatically generated by vaxia.org.\\r\\nYou are receiving this email as part of your membership at vaxia.org.\\r\\nDo not reply this this email, it is not a monitored account and messages will not be received by a human.\\r\\n~~~~~~ ",
            "language" : [ "" ]
          }
        },
        { "userpoints_action_grant_points" : {
            "user" : [ "entity-fetched" ],
            "points" : "-10",
            "tid" : "0",
            "entity" : [ "node" ],
            "description" : "-10 v-rep for a strike.",
            "operation" : "Remove",
            "display" : 0,
            "moderate" : "approved"
          }
        }
      ]
    }
  }');
  return $items;
}
